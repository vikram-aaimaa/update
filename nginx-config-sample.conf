# NGINX Configuration for Boganto Blog
# This configuration properly routes requests between frontend (Next.js) and backend (PHP)
#
# File location: /etc/nginx/sites-available/boganto.com
# Enable with: sudo ln -s /etc/nginx/sites-available/boganto.com /etc/nginx/sites-enabled/
# Test config: sudo nginx -t
# Reload: sudo systemctl reload nginx

# Upstream definitions
upstream nextjs_blog {
    server 127.0.0.1:3000;
    keepalive 64;
}

upstream php_backend {
    server 127.0.0.1:8000;  # Adjust if your PHP server runs on different port
    keepalive 64;
}

# Rate limiting zones (optional but recommended)
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=30r/s;

# HTTP to HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name boganto.com www.boganto.com;
    
    # Redirect all HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

# Main HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name boganto.com www.boganto.com;
    
    # SSL Configuration (adjust paths to your certificates)
    ssl_certificate /etc/letsencrypt/live/boganto.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/boganto.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Logging
    access_log /var/log/nginx/boganto-access.log;
    error_log /var/log/nginx/boganto-error.log warn;
    
    # Max upload size (adjust as needed for blog images)
    client_max_body_size 20M;
    
    # Root directory for static files
    root /var/www/boganto;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/javascript application/json image/svg+xml;
    
    # ==============================================
    # SECTION 1: API Routes → PHP Backend
    # ==============================================
    
    location /api/ {
        # Apply rate limiting
        limit_req zone=api_limit burst=20 nodelay;
        
        # Proxy to PHP backend
        proxy_pass http://php_backend/api/;
        
        # Essential proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # CORS headers (adjust origins as needed)
        add_header Access-Control-Allow-Origin "$http_origin" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Max-Age 3600 always;
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }
    
    # ==============================================
    # SECTION 2: Uploads Directory → Static Files
    # ==============================================
    
    location /uploads/ {
        alias /var/www/boganto/uploads/;
        
        # Cache control for images
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # Security - prevent script execution
        location ~ \.(php|py|pl|sh)$ {
            deny all;
        }
        
        # CORS for images
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        
        # Handle missing files gracefully
        try_files $uri =404;
        
        # Logging for debugging (can disable in production)
        access_log /var/log/nginx/uploads-access.log;
    }
    
    # ==============================================
    # SECTION 3: Blog Application → Next.js
    # ==============================================
    
    location /blog/ {
        # Apply rate limiting
        limit_req zone=general_limit burst=50 nodelay;
        
        # Proxy to Next.js
        proxy_pass http://nextjs_blog/blog/;
        
        # Essential headers for Next.js
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Important for Next.js hot reload in development
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    
    # Next.js static assets with aggressive caching
    location /blog/_next/static/ {
        proxy_pass http://nextjs_blog/blog/_next/static/;
        
        # Aggressive caching for immutable static assets
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Next.js image optimization endpoint
    location /blog/_next/image {
        proxy_pass http://nextjs_blog/blog/_next/image;
        
        # Image optimizer specific settings
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache optimized images
        proxy_cache_valid 200 30d;
        add_header Cache-Control "public, max-age=2592000";
        
        # Longer timeout for image processing
        proxy_read_timeout 120s;
    }
    
    # ==============================================
    # SECTION 4: Root and Other Routes
    # ==============================================
    
    # Root redirect (optional - adjust as needed)
    location = / {
        # Option 1: Redirect to blog
        return 301 /blog/;
        
        # Option 2: Serve static landing page
        # try_files /index.html =404;
    }
    
    # Favicon and robots.txt
    location = /favicon.ico {
        log_not_found off;
        access_log off;
        expires 30d;
    }
    
    location = /robots.txt {
        log_not_found off;
        access_log off;
        expires 30d;
    }
    
    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ==============================================
# ALTERNATIVE: CloudFront Configuration Notes
# ==============================================
#
# If using CloudFront instead of NGINX, configure behaviors as follows:
#
# 1. Origin Setup:
#    - Origin 1 (Next.js): nextjs.boganto.com:3000
#    - Origin 2 (PHP API): api.boganto.com:8000
#    - Origin 3 (S3 for uploads): boganto-uploads.s3.amazonaws.com
#
# 2. Behaviors (in order of precedence):
#    
#    a) /blog/_next/static/*
#       - Origin: Next.js Origin
#       - Cache Policy: CachingOptimized (1 year TTL)
#       - Compress: Yes
#       
#    b) /blog/_next/image*
#       - Origin: Next.js Origin
#       - Cache Policy: Custom (30 days TTL)
#       - Allowed methods: GET, HEAD, OPTIONS
#       
#    c) /blog/*
#       - Origin: Next.js Origin
#       - Cache Policy: CachingDisabled (or very short TTL)
#       - Allowed methods: GET, HEAD, OPTIONS
#       - Forward headers: Host, Origin, Accept, Accept-Language
#       
#    d) /api/*
#       - Origin: PHP API Origin
#       - Cache Policy: CachingDisabled
#       - Allowed methods: GET, HEAD, OPTIONS, PUT, POST, PATCH, DELETE
#       - Forward headers: ALL
#       - Forward cookies: ALL
#       
#    e) /uploads/*
#       - Origin: S3 Origin (or PHP Origin)
#       - Cache Policy: CachingOptimized (1 year TTL)
#       - Compress: Yes
#       
#    f) Default (*)
#       - Origin: Next.js Origin (or static S3)
#       - Cache Policy: CachingOptimized
#
# 3. WAF Rules:
#    - Ensure rate limiting rules don't block legitimate traffic
#    - Whitelist your office/deployment IPs if needed
#    - Monitor CloudWatch logs for blocked requests
#
# ==============================================
